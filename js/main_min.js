function browser(e){return(e=is.chrome())?"chrome":(e=is.firefox(),e?"firefox":"no es ni firefox ni chrome")}function os(e){return(e=is.android())?"android":(e=is.windows(),e?"windows":"no es ni android ni windows")}function checkWarning(e,o){console.log("el estado de visualizacion del chat actual es "+document.getElementById(e).style.display),("none"===document.getElementById(e).style.display||0==document.getElementById("chat").style.opacity&&"block"===document.getElementById(e).style.display)&&("inline-block"===document.getElementById("chatWarn"+o).style.display?console.log("no se cuenta el warning del mensaje porque ya esta mostrandose el chatWarn"+o):($("#chatWarn"+o).css("display","inline-block"),contadorChat++),document.getElementById("nuevoMensaje").style.display="block",$.notify("Nuevo Mensaje de Texto Recibido","success"),audio1.play())}function verificaChat(e,o,n){var t;for(t in usuarioRemoto)if(e===usuarioRemoto[t])return void oldChat(e,o,n);nuevoChat(e,o,n)}function oldChat(e,o,n){o=o.replace(/\n/g,"<br>"),"out"===n?"block"===$(".writing").css("display")?($(".writing").remove(),document.getElementById("chat"+e).innerHTML=document.getElementById("chat"+e).innerHTML+'<p class="enviado">'+o+'</p><div class="writing"><img id="typing" preload="auto" src="res/imagenes/typing.gif" style="height: 35px;"></div>',mensaje.value=""):(document.getElementById("chat"+e).innerHTML=document.getElementById("chat"+e).innerHTML+'<p class="enviado">'+o+"</p>",mensaje.value=""):"_Usuario_Escribiendo_#001"===o?(console.log("Simbolo de tipeando va a mostrarse si chat respectivo esta block y la opacidad de chat esta en 1"),"1"===$("#chat").css("opacity")&&"block"===$("#chat"+e).css("display")&&(document.getElementById("chat"+e).innerHTML=document.getElementById("chat"+e).innerHTML+'<div class="writing"><img id="typing" preload="auto" src="res/imagenes/typing.gif" style="height: 35px;"></div>',console.log("Simbolo de tipeando mostrandose"))):"_Usuario_No_Escribiendo_#002"===o?$(".writing").remove():(console.log("el mensaje entrante es: "+o),$(".writing").remove(),document.getElementById("chat"+e).innerHTML=document.getElementById("chat"+e).innerHTML+'<p class="recibido">'+o+"</p>"),"block"===$("#chatArea").css("display")&&"1"===$("#chat").css("opacity")&&$("#chatArea").animate({scrollTop:document.getElementById("chatArea").scrollHeight-document.getElementById("chatArea").clientHeight},500)}function onChatClick(){console.log("Haz seleccionado el chat "+this.id),document.getElementById("chat"+this.id).style.display="block",destinoChat.value=this.id,destinoChat.disabled=!0,document.getElementById("chatControl").style.display="block",document.getElementById("chatLobby").style.display="none","inline-block"===document.getElementById("chatWarn"+this.id).style.display&&($("#chatWarn"+this.id).css("display","none"),0==--contadorChat&&(document.getElementById("nuevoMensaje").style.display="none"))}function nuevoChat(e,o,n){if("_Usuario_Escribiendo_#001"!==o){document.getElementById("noIM").style.display="none";var t=document.getElementById("historialMensajes");t.style.display="block",t.innerHTML="<tr class='historial' id='"+e+"'><td  class='historialIn'><i class='material-icons'>chat</i> Chat con "+e+"<i id='chatWarn"+e+"' class='material-icons ' style='display:none'>error</i></td></tr>"+t.innerHTML,usuarioRemoto.push(e),$(".historial").each(function(){this.addEventListener("click",onChatClick,!1)}),document.getElementById("chat000").style.display="none",chatHistory.innerHTML="out"==n?chatHistory.innerHTML+"<div id='chat"+e+"' class='conversaciones' style='display:block;'></div>":chatHistory.innerHTML+"<div id='chat"+e+"' class='conversaciones' style='display:none;'></div>",oldChat(e,o,n)}else oldChat(e,o,n)}function checkRegister(){console.log("Re Registrando"),usuarioLocal.register(config1)}function w3_open(){$(document).ready(function(){$("#mySidebar").css("display","block"),$("#mySidebar").css("z-index","20"),$(".wrapper").css("display","none")})}function w3_close(){$(document).ready(function(){$("#mySidebar").css("display","none"),$("#mySidebar").css("z-index","0"),$(".wrapper").css("display","block")})}function showVideo(e){contenedorVideos.style.display="block",document.getElementById("principal").style.display="none"}function cerrarVideos(e){return e=null,botonCallPBX.disabled=!1,contenedorVideos.style.display="none",document.getElementById("principal").style.display="block",1===ringbackTone.status&&ringbackTone.stopRinging(),document.getElementById("dtmfPad").style.display="none",document.getElementById("botonPad").innerHTML="<i  class='material-icons ' style='font-size:36px;color:black'>dialpad</i>",document.getElementById("mediaLocal").style.display="block",toogleVideo.innerText="videocam",videoRemoto.muted=!1,toogleMute.innerText="volume_up",$("#ringing").css("display","none"),$(".num").css("display","inline-block"),$("#clear").css("opacity","1"),e}function cambiaOpacidad(){""===containerBotonesCtl.style.getPropertyValue("opacity")&&(containerBotonesCtl.style.opacity=0),"0"===containerBotonesCtl.style.getPropertyValue("opacity")&&(console.log("la opacidad de los botones de control es "+containerBotonesCtl.style.getPropertyValue("opacity")),containerBotonesCtl.style.opacity=.65,setTimeout(function(){"none"===dtmfPad.style.getPropertyValue("display")&&(containerBotonesCtl.style.opacity=0)},4500),console.log("la opacidad de los botones de control es "+containerBotonesCtl.style.getPropertyValue("opacity")))}Notification.requestPermission().then(function(e){console.log(e)});var sistemaOS=os(),explorador=browser();console.log("tu sistema operativo es "+sistemaOS+" y tu explorador es "+explorador);var sipUser=document.querySelector("input#usuario"),sipPasswd=document.querySelector("input#contraseña"),statusReg=document.getElementById("statusReg"),userReg=document.getElementById("userReg"),botonRegistro=document.querySelector("button#registro"),noRegistro=document.getElementById("noRegistro"),botonCallPBX=document.querySelector("button#botonCallPBX"),videoCam=window.video=document.querySelector("video#mediaLocal"),videoRemoto=window.video=document.querySelector("video#mediaRemoto"),botonColgarPBX=document.querySelector("button#botonColgarPBX"),user,passwd,config1,intervalo,expireTime=6e4,usuarioLocal,numeroTexto=document.getElementById("escritoLLamada"),sessionIN,notificacion,botonRechazar=document.getElementById("botonRechazar"),sessionOUT,destino,opciones={media:{render:{remote:videoRemoto,local:videoCam}}},botonSend=document.getElementById("send"),mensaje=document.getElementById("chatMessage"),chatHistory=document.getElementById("chatArea"),destinoChat=document.getElementById("destinoChat"),usuarioRemoto=new Array,contadorChat=0,contadorLetras=-1,flagMensaje=!0,typingImg=document.getElementById("typing"),toggleVideo=document.getElementById("toggleVideo"),botonVideoOff=document.getElementById("botonVideoOff"),botonMute=document.getElementById("botonMute"),toogleMute=document.getElementById("toogleMute"),contenedorVideos=document.getElementById("contenedorVideos"),containerBotonesCtl=document.getElementById("containerBotonesCtl");$(".botonMenu").attr("disabled","disabled"),$("#usuario").keydown(function(e){if(13==e.keyCode)return sipPasswd.focus(),!1}),$("#contraseña").keydown(function(e){if(13==e.keyCode)return botonRegistro.click(),!1}),botonRegistro.onclick=function(){botonRegistro.disabled=!0;var e;user=sipUser.value,passwd=sipPasswd.value,config1={uri:user+"@34.200.151.61",wsServers:"wss://34.200.151.61:7443",authorizationUser:user,stunServers:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"],password:passwd,register:!0,autostart:!0,log:[{builtinEnabled:!1}],traceSip:!1},""===user||""===passwd?($.notify("Datos de registro incompleto","warn"),botonRegistro.disabled=!1):(usuarioLocal=new SIP.UA(config1),e=!0,audio1.muted=!0,audio1.play(),audio1.addEventListener("ended",function(){audio1.muted&&(audio1.muted=!1)}),audio2.muted=!0,audio2.play(),audio2.addEventListener("ended",function(){audio2.muted&&(audio2.muted=!1)})),usuarioLocal.on("registered",function(){w3_close(),$("#botonMenu").css("opacity","1"),$("#contenedorLogin").css("opacity","0"),$("#contenedorLogin").css("z-index","0"),$(".botonMenu").removeAttr("disabled"),document.getElementById("dial").click(),e&&($.notify("Usuario Registrado","success"),e=!1,intervalo=setInterval(checkRegister,1e3*expireTime)),userReg.innerText=user,statusReg.innerHTML="<b>Registrado</b>",statusReg.style.color="green"}),usuarioLocal.on("registrationFailed",function(){$.notify("Verifique su usuario o password","error"),botonRegistro.disabled=!1}),noRegistro.onclick=function(){usuarioLocal.unregister(),botonRegistro.disabled=!1,$.notify("Desregistrado","warn"),sipUser.value="",sipPasswd.value="",userReg.innerText="XXX",statusReg.innerHTML="<b>No Registrado</b>",statusReg.style.color="red",location.reload(!0)},usuarioLocal.on("invite",function(e){console.log("Llamada repicando"),ringbackTone.startRinging(),$.notify("Llamada entrante","success"),document.getElementById("dial").click(),$("#ringing").css("display","block"),$(".num").css("display","none"),$("#clear").css("opacity","0"),"windows"!==sistemaOS&&"mac"!==sistemaOS&&"linux"!==sistemaOS||(notificacion=new Notification("Llamada entrante",{body:"Click para ver dialer"}),setTimeout(notificacion.close.bind(notificacion),5e3),notificacion.onclick=function(){console.log("click en notificacion"),window.focus(),notificacion.close()}),(sessionIN=e).on("bye",function(){console.log("Llamada finalizada"),$.notify("Llamada finalizada","error"),sessionIN=cerrarVideos(sessionIN)}),sessionIN.on("accepted",function(){console.log("llamada Entrante aceptada"),ringbackTone.stopRinging()}),sessionIN.on("canceled",function(){console.log("llamada entrante cancelada"),sessionIN=cerrarVideos(sessionIN)}),sessionIN.on("rejected",function(){console.log("llamada entrante rechazada"),sessionIN=cerrarVideos(sessionIN)}),sessionIN.on("failed",function(){console.log("llamada entrante fallida"),sessionIN=cerrarVideos(sessionIN)})}),botonCallPBX.onclick=function(){if(console.log("boton llamar presionado"),botonCallPBX.disabled=!0,sessionIN)botonCallPBX.disabled=!1,"windows"!==sistemaOS&&"mac"!==sistemaOS&&"linux"!==sistemaOS||notificacion.close.bind(notificacion),sessionIN.accept(opciones),showVideo(sessionIN);else{if(""===(destino=numeroTexto.value))return $.notify("Debe introducir un numero","error"),void(botonCallPBX.disabled=!1);console.log("llamando a "+destino),(sessionOUT=usuarioLocal.invite(destino+"@34.200.151.61",opciones)).on("progress",function(){console.log("llamada en progreso"),0===ringbackTone.status&&ringbackTone.startRinging()}),sessionOUT.on("accepted",function(){console.log("llamada saliente  aceptada"),showVideo(sessionOUT),ringbackTone.stopRinging()}),sessionOUT.on("canceled",function(){console.log("llamada cancelada"),sessionOUT=cerrarVideos()}),sessionOUT.on("rejected",function(){console.log("llamada rechazada"),sessionOUT=cerrarVideos()}),sessionOUT.on("failed",function(){console.log("llamada fallida"),sessionOUT=cerrarVideos()}),sessionOUT.on("bye",function(e){e="Llamada finalizada",console.log(e),$.notify(e,"error"),sessionOUT=cerrarVideos()})}},usuarioLocal.on("message",function(e){if(console.log("mensaje recibido: "+e.body),"_Usuario_No_Escribiendo_#002"===e.body&&$(".writing"))return console.log("se borrara el writing"),void $(".writing").remove();var o=e.remoteIdentity.uri.user,n="chat"+o;if(verificaChat(o,e.body,"in"),"_Usuario_Escribiendo_#001"!==e.body&&(checkWarning(n,o,e.body),"windows"===sistemaOS||"mac"===sistemaOS||"linux"===sistemaOS)){var t=new Notification("Mensaje entrante",{body:"Click para ver dialer"});setTimeout(t.close.bind(t),2e3),t.onclick=function(){console.log("click en notificacion2"),window.focus(),t.close()}}})},botonSend.onclick=function(){contadorLetras=0,flagMensaje=!0,""===mensaje.value?$.notify("No ha introducido ningún mensaje","error"):""!==destinoChat.value?(usuarioLocal.message(destinoChat.value+"@34.200.151.61",mensaje.value),console.log("enviando mensaje "+mensaje.value),audio2.play(),destinoChat.disabled=!0,verificaChat(destinoChat.value,mensaje.value,"out")):$.notify("No ha introducido ningún destinatario","error")},$("#destinoChat").keydown(function(e){if(13==e.keyCode)return mensaje.focus(),!1}),$("#chatMessage").keyup(function(e){13==e.keyCode?(console.log("boton enter up"),mensaje.value=""):8==e.keyCode&&(contadorLetras>0&&contadorLetras--,""===mensaje.value&&(flagMensaje=!0,console.log("mensaje en vacio wei"),usuarioLocal.message(destinoChat.value+"@34.200.151.61","_Usuario_No_Escribiendo_#002")))}),$("#chatMessage").keydown(function(e){32==e.keyCode?contadorLetras=0:9==e.keyCode?console.log("se pulso el tabulador"):contadorLetras++,24==contadorLetras&&(mensaje.value=mensaje.value+"\n",contadorLetras=0),13==e.keyCode&&e.shiftKey?(mensaje.value=mensaje.value+"\n",console.log("boton enter y shift presionado"),contadorLetras=0):13==e.keyCode&&(console.log("boton enter presionado"),botonSend.click()),0!==contadorLetras&&flagMensaje&&(usuarioLocal.message(destinoChat.value+"@34.200.151.61","_Usuario_Escribiendo_#001"),flagMensaje=!1,console.log("el contador de letras es "+contadorLetras)),console.log("el keycode presionado es "+e.keyCode+" y el numero de letras  es "+contadorLetras+" y la caja de chat tiene este valor "+mensaje.value)});var botonNewChat=document.getElementById("newChat"),botonBack=document.getElementById("back");botonNewChat.onclick=function(){usuarioLocal?(document.getElementById("chatControl").style.display="block",destinoChat.disabled&&(destinoChat.disabled=!1,destinoChat.value=""),document.getElementById("chatLobby").style.display="none"):$.notify("Debe Iniciar Sesion antes de enviar mensajes","error")},botonBack.onclick=function(){document.getElementById("chatControl").style.display="none",$(".conversaciones").css("display","none"),document.getElementById("chatLobby").style.display="block",document.getElementById("chat000").style.display="block",mensaje.value="",destinoChat.value=""},botonRechazar.onclick=function(){console.log("boton rechazar presionado"),sessionIN?sessionIN.reject():sessionOUT.terminate()},botonColgarPBX.onclick=function(){if(sessionIN)sessionIN.bye();else{if(12===sessionOUT.status)return void sessionOUT.bye();if(2===sessionOUT.status)return void sessionOUT.cancel();sessionOUT.terminate()}},$(document).ready(function(){$("#menuContainer button").click(function(){console.log("el id del boton presionado es "+$(this).attr("id"));var e=$(this).attr("id");switch($("#zonaCentral > div").css("opacity","0"),$("#zonaCentral > div").css("z-index","0"),e){case"im":$("#chat").css("opacity","1"),$("#chat").css("z-index","10"),botonBack.click();break;case"setting":$("#config").css("opacity","1"),$("#config").css("z-index","10");break;case"contact":$("#contactos").css("opacity","1"),$("#contactos").css("z-index","10");break;case"dial":$("#teclas").css("opacity","1"),$("#teclas").css("z-index","10");break;case"buzon":$("#teclas").css("opacity","1"),$("#teclas").css("z-index","10"),numeroTexto.value=userReg.innerText,botonCallPBX.click(),numeroTexto.value=""}}),$(".tabla-dialpad button").mousedown(function(){$(this).css("box-shadow","none")}),$(".tabla-dialpad button").mouseup(function(){$(this).css("box-shadow","0 8px 16px 0 rgba(0,0,0,0.2),0 6px 10px 0 rgba(0,0,0,0.19)")})});var selecDest=document.querySelector("select#destinoLLamada");selecDest.onchange=function(){var e=selecDest.value;if("jainer"===e)destino="205",numeroTexto.value=destinoChat.value=205;else if("joel"===e)destino="203",numeroTexto.value=destinoChat.value=203;else{if("did"!==e)return void console.log("no se ha seleccionado destino");numeroTexto.value=destinoChat.value=15208914487,destino="15208914487"}console.log("se va a llamar a "+destino)},numeroTexto.oninput=function(){""!=selecDest.value&&(selecDest.selectedIndex="0")};var valores={num1:{a:1},num2:{a:2},num3:{a:3},num4:{a:4},num5:{a:5},num6:{a:6},num7:{a:7},num8:{a:8},num9:{a:9},asterisco:{a:"*"},num0:{a:0},numeral:{a:"#"},clear:{a:"clr"},botonCallPBX:{a:"call"},botonRechazar:{a:"bye"}};$(".js-dtmf-interface").on("mousedown touchstart",function(e){e.preventDefault();var o=$(this).attr("id"),n=dtmfFrequencies[o],t=valores[o];console.log("El boton presionado es "+t.a),dtmf.freq1=n.f1,dtmf.freq2=n.f2,0==dtmf.status&&dtmf.start(),"clr"!=t.a?numeroTexto.value=numeroTexto.value+t.a:numeroTexto.value=""}),$(window).on("mouseup touchend",function(){"undefined"!=typeof dtmf&&dtmf.status&&setTimeout(function(){dtmf.stop()},180)}),document.getElementById("dtmfPad").style.display="none",document.getElementById("botonPad").onclick=function(){"none"===document.getElementById("dtmfPad").style.display?(console.log("Teclado DTMF ON"),document.getElementById("dtmfPad").style.display="block",containerBotonesCtl.style.opacity=.65,document.getElementById("botonPad").innerHTML="<img style='width:36px;height:36px;margin:0 0 0 0' src='res/imagenes/dialpad_none.png'>"):(console.log("Teclado DTMF OFF"),document.getElementById("dtmfPad").style.display="none",containerBotonesCtl.style.opacity=0,document.getElementById("botonPad").innerHTML="<i  class='material-icons ' style='font-size:36px;color:black'>dialpad</i>")},$(document).ready(function(){$("#dtmfPad button").click(function(e){var o=$(this).attr("id");e=sessionIN||sessionOUT,console.log("dtmf enviado es "+o),"num"===o?o="#":"ast"===o&&(o="*"),e.dtmf(o)})}),botonVideoOff.onclick=function(){"videocam"===toogleVideo.innerText?($.notify("Video Local OFF","error"),sessionIN?sessionIN.getLocalStreams()[0].getVideoTracks()[0].enabled=!1:sessionOUT.getLocalStreams()[0].getVideoTracks()[0].enabled=!1,toogleVideo.innerText="videocam_off",document.getElementById("mediaLocal").style.display="none"):(sessionIN?sessionIN.getLocalStreams()[0].getVideoTracks()[0].enabled=!0:sessionOUT.getLocalStreams()[0].getVideoTracks()[0].enabled=!0,$.notify("Video Local ON","success"),toogleVideo.innerText="videocam",document.getElementById("mediaLocal").style.display="block")},botonMute.onclick=function(){"mic"===toogleMute.innerText?(sessionIN?sessionIN.getLocalStreams()[0].getAudioTracks()[0].enabled=!1:sessionOUT.getLocalStreams()[0].getAudioTracks()[0].enabled=!1,toogleMute.innerText="mic_off",$.notify("Mic off","error")):(sessionIN?sessionIN.getLocalStreams()[0].getAudioTracks()[0].enabled=!0:sessionOUT.getLocalStreams()[0].getAudioTracks()[0].enabled=!0,toogleMute.innerText="mic",$.notify("Mic on","success"))};var sipExpire=document.getElementById("sipExpire");sipExpire.onchange=function(){isNaN(sipExpire.value)?($.notify("Debe introdicir un número","error"),sipExpire.value=""):(expireTime=1e3*sipExpire.value,intervalo&&(usuarioLocal.register(config1),clearInterval(intervalo),intervalo=setInterval(checkRegister,expireTime)),$.notify("Sip Expire "+expireTime/1e3+" s","success"))},$("#botonMenu").click(function(){"none"===$("#menu").css("display")?$("#menu").css("display","block"):$("#menu").css("display","none")}),contenedorVideos.addEventListener("click",cambiaOpacidad),contenedorVideos.addEventListener("mousemove",cambiaOpacidad);